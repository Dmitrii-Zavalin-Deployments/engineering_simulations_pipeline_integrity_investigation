name: Run Integrity Validation

on:
  push:
  workflow_dispatch:

jobs:
  code_quality_check:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ðŸ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ§¹ Run autoflake to remove unused imports
        run: |
          autoflake --in-place --recursive --remove-unused-variables --remove-all-unused-imports src

      - name: ðŸ’€ Run vulture to find dead code
        run: |
          vulture src || echo "âš ï¸ Vulture found unused code â€” review manually if needed"

      - name: ðŸš€ Commit autoflake changes
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          git config --global user.name "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"
          git add .
          git diff --cached --quiet || (
            git commit -m "ðŸ§¹ Auto-clean: removed unused imports and variables"
            git push || echo "No changes to push"
          )
  
  integrity-check:
    name: Integrity Investigation
    needs: code_quality_check
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Python dependencies
        run: pip install -r requirements.txt

      - name: ðŸ“¦ Install Dropbox SDK
        run: pip install dropbox

      - name: ðŸ”“ Make download script executable
        run: chmod +x src/download_from_dropbox.sh

      - name: â¬‡ï¸ Download files from Dropbox
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        run: src/download_from_dropbox.sh

      - name: ðŸ“ List full repository structure (recursive)
        run: ls -R

      - name: ðŸ”“ Make navier_stokes validation script executable
        run: chmod +x validators/validate_navier_stokes_results.sh

      - name: ðŸ§­ Set PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      - name: ðŸ§­ Show PYTHONPATH
        run: echo $PYTHONPATH

      - name: âœ… Validate navier_stokes_results using shell script
        run: validators/validate_navier_stokes_results.sh

      - name: âœ… Validate enriched_metadata.json
        run: python validators/validate_enriched_metadata.py

      - name: âœ… Validate flow_data.json
        run: python validators/validate_flow_data.py

      - name: âœ… Validate boundary_conditions_gmsh.json
        run: python validators/validate_boundary_conditions_gmsh.py

      - name: âœ… Validate geometry_masking_gmsh.json
        run: python validators/validate_geometry_masking_gmsh.py

      - name: âœ… Validate fluid_simulation_input.json
        run: python validators/validate_fluid_simulation_input.py

      - name: Run validation tests
        run: pytest tests/



