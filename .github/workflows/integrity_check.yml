name: Run Integrity Validation

on:
  push:
  workflow_dispatch:

jobs:
  integrity-check:
    name: Integrity Investigation
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 📦 Install Python dependencies
        run: pip install -r requirements.txt

      - name: 📦 Install Dropbox SDK
        run: pip install dropbox

      - name: 🔓 Make download script executable
        run: chmod +x src/download_from_dropbox.sh

      - name: ⬇️ Download files from Dropbox
        env:
          APP_KEY: ${{ secrets.APP_KEY }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
          REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
        run: src/download_from_dropbox.sh

      - name: 📁 List full repository structure (recursive)
        run: ls -R

      - name: 🔓 Make navier_stokes validation script executable
        run: chmod +x validators/validate_navier_stokes_results.sh

      - name: 🧭 Set PYTHONPATH
        run: echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      - name: 🧭 Show PYTHONPATH
        run: echo $PYTHONPATH

      - name: ✅ Validate navier_stokes_results using shell script
        run: validators/validate_navier_stokes_results.sh

      - name: ✅ Validate enriched_metadata.json
        run: python validators/validate_enriched_metadata.py

      - name: ✅ Validate flow_data.json
        run: python validators/validate_flow_data.py

      - name: ✅ Validate boundary_conditions_gmsh.json
        run: python validators/validate_boundary_conditions_gmsh.py

      - name: ✅ Validate geometry_masking_gmsh.json
        run: python validators/validate_geometry_masking_gmsh.py

      - name: ✅ Validate fluid_simulation_input.json
        run: python validators/validate_fluid_simulation_input.py

      - name: Run validation tests
        run: pytest tests/



